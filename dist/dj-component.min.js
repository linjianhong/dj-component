"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};angular.module("dj-form",["dj-ui"]),angular.module("dj-pop",["dj-ui","ngAnimate"]),angular.module("dj-ui",["ngAnimate"]),function(e,n,t){function i(e,t,i,a,o,r){function l(n){var t=u.valid;return t===e.valid&&n===e.dirty?a.reject("状态未改变"):(e.valid=t,e.dirty=n,a.when({valid:t,dirty:n}))}var c=this,s=function(n){if(!n)return void t.html("");var i=n.componentEdit||n.component,a=n.css.hostEdit||n.css.host||"normal";if(i){var l='\n          <div class="'+a+" {{theValid.dirty&&'ng-dirty'||''}} {{!theValid.valid&&'ng-invalid'||''}}\">\n            <div class=\"a flex prompt-top\" dj-form-default-tip ng-hide=\"$ctrl.configs.hideTip\"></div>\n            <"+i+' class="'+(n.css.dataEdit||n.css.data||"b flex-v-center")+'"\n              mode="edit"\n              configs="$ctrl.configs"\n              init-value="initValue"\n              the-valid="theValid"\n              on-change="onChange(value)"\n            ></'+i+">\n          </div>";return t.html(l),void o(t.contents())(e)}var c=r.getSafeType(n.type),s=n.pre+c,a=n.css.hostEdit||n.css.host||"normal",l="\n        <"+s+'\n          class="'+a+' {{theValid.dirty&&\'ng-dirty\'||\'\'}} {{!theValid.valid&&\'ng-invalid\'||\'\'}}"\n          configs="$ctrl.configs"\n          init-value="initValue"\n          on-change="onChange(value)"\n          the-valid="theValid"\n        ></'+s+">\n      ";t.html(l);var u=o(t.contents())(e),d=e.$$childHead,m=n.template||r.getTemplateEdit(c);u.html(m),o(u.contents())(d)},u=e.theValid=this.theValid={valid:!0,require:!1,tip:"",configs:!1,configReady:!1,value:"",valueReady:!1,setConfig:function(e){u.configs=e,e&&(u.configs.param||(u.configs.param={}),u.configReady=!0,u.calc())},setValue:function(t){return(!u.valueReady||!n.equals(u.value,t))&&(u.valueReady=!0,n.isArray(t)?(u.value=n.merge([],t),e.initValue=n.merge([],t)):n.isObject(t)?(u.value=n.merge({},t),e.initValue=n.merge({},t)):(u.value=t,e.initValue=t),u.calc(),!0)},calc:function(){if(u.configReady&&u.valueReady){var e=u.configs.param.valid||u.configs.valid||{},t=n.extend({required:"required"},u.configs.invalid,u.configs.param.invalid);if(e.minLength&&(e.minlength=e.minlength||e.minLength),e.maxLength&&(e.maxlength=e.maxlength||e.maxLength),u.valid=!0,u.tip="",u.require=e.require,e.require){if(!u.value&&0!==u.value)return u.valid=!1,void(u.tip=t.required||e.errorTip||"")}else if(!u.value&&0!==u.value)return;if(e.pattern&&(e.pattern instanceof RegExp||(e.pattern=new RegExp(e.pattern)),!e.pattern.test(u.value)))return u.valid=!1,void(u.tip=t.pattern||e.errorTip||"");if(e.max){var i="object"==_typeof(u.value)||Number.isNaN(Number(u.value)),a=i||+u.value>e.max;if(a)return u.valid=!1,void(u.tip=(i?t.number:t.max)||e.errorTip||"")}if(e.min){var i="object"==_typeof(u.value)||Number.isNaN(Number(u.value)),a=i||+u.value<e.min;if(a)return u.valid=!1,void(u.tip=(i?t.number:t.min)||e.errorTip||"")}if(e.maxlength){var o=u.value||"",a=!o.hasOwnProperty("length")||o.length>e.maxlength;if(a)return u.valid=!1,void(u.tip=t.maxlength||e.errorTip||"")}if(e.minlength){var o=u.value||"",a=!o.hasOwnProperty("length")||o.length<e.minlength;if(a)return u.valid=!1,void(u.tip=t.minlength||e.errorTip||"")}}}};this.onChangesCtrl=function(n){n.initValue&&(u.setValue(n.initValue.currentValue),e.valid="----",l(!1).then(d)),n.configs&&(s(n.configs.currentValue),u.setConfig(n.configs.currentValue),e.valid="----",l(!1).then(d))},e.valid=!0,e.dirty=!1;var d=function(e){c.onStatusChange&&c.onStatusChange({item:c.configs,valid:e.valid,dirty:e.dirty})};e.onChange=function(n){u.setValue(n)&&l(!0).then(d).finally(function(){c.onValueChange({item:c.configs,value:n,valid:e.valid,dirty:e.dirty})})}}function a(e,n,t,i,a,o){function r(){n.html(""),n.addClass("empty")}this.onChangesCtrl=function(n){n.configs&&(e.configs=n.configs.currentValue),n.initValue&&(e.value=n.initValue.currentValue),l(e.configs,e.value)};var l=function(i,l){if(!i)return void t(r);if(i.show){if("empty"==i.show.autohide&&0!==l&&!l)return void t(r);if(!("zero length"!=i.show.autohide||l&&l.length))return void t(r)}var c=i.componentShow||i.component,s=i.css.hostShow||i.css.host||"normal";if(c){var u='\n          <div class="'+s+'">\n            <div flex-row="5em" class="{{configs.css.hostBodyShow}}">\n              <span class="a" ng-hide="configs.hideTip">{{configs.title}}</span>\n              <'+c+' class="'+(i.css.dataShow||i.css.data||"flex-v-center")+'"\n                mode="show"\n                configs="$ctrl.configs"\n                init-value="initValue"\n              ></'+c+">\n            </div>\n          </div>";return n.html(u),void a(n.contents())(e)}var d=o.getSafeType(i.type),m=i.pre+d,s=i.css.hostShow||i.css.host||"normal",u="\n        <"+m+'-show\n          class="'+s+'"\n          configs="$ctrl.configs"\n          init-value="$ctrl.initValue"\n        ></'+m+"-show>\n      ";n.html(u);var f=a(n.contents())(e),p=e.$$childHead,v=i.template||o.getTemplateShow(d);f.html(v),a(f.contents())(p)}}n.module("dj-form").component("djFormItemHost",{bindings:{mode:"<",configs:"<",initValue:"<",onValueChange:"&",onStatusChange:"&"},controller:["$scope","$element","$timeout","$q","$compile","DjFormDefaultDefine",function(e,n,t,o,r,l){var c=this,s=!1,u={};this.$onChanges=function(d){if(["configs","initValue","onValueChange","onStatusChange"].map(function(e){d[e]&&(u[e]=d[e])}),d.mode){var m=d.mode.currentValue;if("show"!=m&&(m="edit"),m!=s){s=m;("show"==m&&a||i).call(c,e,n,t,o,r,l)}}s&&(c.onChangesCtrl(u),u={})}}]})}(window,angular),angular.module("dj-form").filter("formFormat",function(){return function(e,n){return angular.isString(n)?(angular.isString(e)||(e=""),n.replace(/\{1\}/g,e)):e}}),function(e,n,t){function i(e,t,i,a,r){function l(n){e.memValue={},"object"===(void 0===n?"undefined":_typeof(n))&&u.ready(function(t){for(var i in n)t.items.find(function(e){return e.name==i})&&(e.memValue[i]=n[i])})}function c(t){if(d={},m={},t){var i=t.templates||{},a=t.pre||o.pre,r=t.css||{};e.configItems=t.items.map(function(e){return n.extend({pre:a,css:r,template:i[e.type]},e)}),t&&u.resolve(t)}}var s=this,u=new r;this.onChangesCtrl=function(n){n.configs&&(e.configs=n.configs.currentValue,c(n.configs.currentValue)),n.initValues&&l(n.initValues.currentValue)},e.memValue={},e.valid=!0,e.dirty=!1;var d={},m={};e.onItemStatusChange=function(n,t,a){d[n.name]=t,m[n.name]=a,e.valid=!Object.keys(d).find(function(e){return!d[e]}),e.dirty=!!Object.keys(m).find(function(e){return m[e]}),i(p)};var f={},p=function(){e.valid===f.valid&&e.dirty===f.dirty||(f.valid=e.valid,f.dirty=e.dirty,s.onFormStatus&&s.onFormStatus({valid:e.valid,dirty:e.dirty}))};e.onItemValueChange=function(n,t,i,a){e.onItemStatusChange(n,i,a),e.memValue[n.name]=t,s.onFormValues&&s.onFormValues({value:e.memValue,valid:e.valid,dirty:e.dirty,item:n})}}function a(e){function t(t,i){if(t&&i){var a=t.templates||{},r=t.pre||o.pre,l=t.css||{};e.configItems=t.items.map(function(e){return n.extend({pre:r,css:l,template:a[e.type+"-show"]},e)})}}this.onChangesCtrl=function(n){n.configs&&(e.configs=n.configs.currentValue),n.initValues&&(e.memValue=n.initValues.currentValue),(n.configs||n.initValues)&&t(e.configs,e.memValue)},e.onItemStatusChange=function(){},e.onItemValueChange=function(){}}var o={pre:"dj-form-default-item-"};n.module("dj-form").value("DJ_FORM_DEFAULT",o),n.module("dj-form").component("djForm",{bindings:{mode:"<",configs:"<",initValues:"<",onFormValues:"&",onFormStatus:"&"},template:'\n      <dj-form-item-host class="{{$ctrl.configs.css.host || \'flex-v\'}} {{$ctrl.configs.css.host2}} mode-{{mode}}"\n        mode="mode==\'show\' && \'show\' || subItem.mode"\n        configs="subItem"\n        init-value="memValue[subItem.name]"\n        on-status-change="onItemStatusChange(item, valid, dirty)"\n        on-value-change="onItemValueChange(item, value, valid, dirty)"\n        ng-repeat="subItem in configItems track by $index"\n        ng-if="!stop"\n      ></dj-form-item>',controller:["$scope","$element","$timeout","$q","DjWaiteReady",function(e,n,t,o,r){var l=this,c=!1,s={};e.stop=!0,this.$onChanges=function(n){if(["configs","initValues","onFormValues","onFormStatus"].map(function(e){n[e]&&(s[e]=n[e])}),n.mode){var i=n.mode.currentValue;if("show"!=i&&(i="edit"),i!=c)return c=e.mode=i,void u(c,s).then(function(){s={}})}if(c&&n.configs)return void u(c,s).then(function(){s={}});c&&l.onChangesCtrl&&t(function(){l.onChangesCtrl(s),s={}})};var u=function(c,s){e.stop=!0;var u=e.memValue||{};return s.configs||(s.configs={}),s.configs.currentValue||(s.configs.currentValue=e.configs),s.initValues||(s.initValues={}),s.initValues.currentValue||(s.initValues.currentValue=u),t(function(){e.stop=!1,("show"==c&&a||i).call(l,e,n,t,o,r),l.onChangesCtrl(s)})}}]})}(window,angular),function(e,n,t){var i=n.module("dj-pop");i.component("djComponentHost",{bindings:{component:"@",param:"<"},controller:["$scope","$element","$compile",function(e,n,t){function i(i,a){if(!i)return void n.html("");var o="";if(a)for(var r in a)e[r]=a[r],o+=" "+r+'="'+r+'"';n.html('<div class="dj-pop-box"><'+i+" "+o+"></"+i+"></div>"),t(n.contents())(e)}var a=this;e.ZZZ="DJ_POP",this.$onChanges=function(e){return e.component&&e.param?void i(e.component.currentValue,e.param.currentValue):e.component?void i(e.component.currentValue,a.param):e.param?void i(a.component,e.param.currentValue):void 0}}]}),i.component("djPopBox",{bindings:{component:"@"},template:'<dj-component-host param="param || options.param" component="{{$ctrl.component}}"></dj-component-host>'}),i.component("djPopToastBox",{bindings:{},template:'<dj-toast delay="{{options.param.delay}}" text="{{options.param.text}}"></dj-toast>'}),i.factory("DjPop",["$compile","$rootScope","DjWaiteReady","$animateCss","$q",function(e,t,i,a,o){function r(n,a){function o(e){setTimeout(function(){d.$destroy(),u&&u.remove(),u=null}),r.resolve(e)}a=a||{};var r=new i,l=a.element||document.body,c=a.scope||t,s=a.template||'<dj-pop-box component="'+n+'"></dj-pop-box>',u=e(s)(c);l.append(u[0]);var d=u.children().scope();d.options=a;d.$on("dj-pop-box-close",function(e,n){e.preventDefault(),o(n)}),d.$on("$locationChangeStart",function(e){e.preventDefault(),o("locationChange")});return r.ready()}function l(a){function r(e){setTimeout(function(){u.$destroy(),m&&m.remove(),m=null}),l.resolve(e)}if(!a||!a.template)return o.reject("无模板");var l=new i,c=a.element||document.body,s=a.scope||t,u=s.$new();u.param=a.param;var d=a.template,m=n.element("<div>"+d+"</div>");n.element(c).append(m),m.scope(u),e(m.contents())(u);u.$on("dj-pop-box-close",function(e,n){e.preventDefault(),r({btnName:n,param:u.param})}),u.$on("$locationChangeStart",function(e){e.preventDefault(),r("locationChange")});return l.ready()}function c(a,o,r){function l(e){setTimeout(function(){d.$destroy(),v&&v.remove(),v=null}),c.resolve(e)}r=r||{};var c=new i,s=r.element||document.body,u=r.scope||t,d=u.$new(),m=[];for(var f in o)o.hasOwnProperty(f)&&(m.push(f.replace(/([A-Z])/g,"-$1").toLowerCase()+'="'+f+'"'),d[f]=o[f]);var p="<"+a+" "+m.join(" ")+"></"+a+">",v=n.element('<div class="djui-fixed-box">'+p+"</div>");n.element(s).append(v),v.scope(d),e(v.contents())(d);d.$on("dj-pop-box-close",function(e,n){e.preventDefault(),l(n)}),d.$on("$locationChangeStart",function(e){e.preventDefault(),l("locationChange")});return c.ready()}function s(e,n,t){return c(e,n,t)}function u(e,n,t){return c(e,n,t).then(function(e){return"OK"!=e?o.reject(e):e})}function d(e,n){return c("djui-gallery",e,n)}function m(e,t){var i={};return n.isObject(e)&&(i=e,t=e.delay,e=e.text),i.template='<dj-toast text="'+e+'" delay="'+t+'"></dj-toast>',l(i)}function f(e,t){var i={param:{body:e,title:t,backClose:1,cancel:{hide:1}}};return n.isObject(e)&&(i=e,i.param||(i={param:i})),i.template='<djui-dialog param="param">'+(i.template||"")+"</djui-dialog>",l(i).then(function(e){return e&&"OK"==e.btnName?e:o.reject(e)})}function p(e,t){var i={param:{body:e,title:t}};return n.isObject(e)&&(i=e,i.param||(i={param:i})),i.template='<djui-dialog param="param">'+(i.template||"")+"</djui-dialog>",l(i).then(function(e){return e&&"OK"==e.btnName?e:o.reject(e)})}function v(e,t){var i={param:{title:e,text:t}};return n.isObject(e)&&(i=e,i.param||(i={param:i})),i.template='<djui-dialog param="param"><djui-dialog-body><textarea class="djui-dialog-input" ng-model="param.text"></textarea></djui-dialog-body></djui-dialog>',l(i).then(function(e){return e&&e.param&&"OK"==e.btnName?e.param.text:o.reject(e)})}return{show:r,alert:f,confirm:p,input:v,toast:m,gallery:d,component:s,dialog:u}}])}(window,angular),function(e,n,t){n.module("dj-ui").directive("flexRow",["$q",function(e){return{restrict:"A",link:function(e,n,t){t.$observe("flexRow",function(e){n.addClass("flex flex-left"),n.children().eq(0).addClass("shrink0"),n.children().eq(1).addClass("flex-1"),n.children()[0].style.opacity=.5,e&&(n.children()[0].style.width=e)})}}}]),n.module("dj-ui").directive("brText",["$q",function(e){return{restrict:"A",link:function(e,n,t){t.$observe("brText",function(e){n.html(e.replace(/\n/g,"<br>"))})}}}])}(window,angular),function(e,n,t){function i(e,t,i,a){function o(){e.djFocus=1,i(function(){e.djFocus=""},300)}var r=this;this.$onChanges=function(n){n.focus&&n.focus.currentValue&&o(),n.initValue&&(e.ngModel=n.initValue.currentValue)},e.onChange=function(e){r.onChange({value:e,initValue:e})},e.clearContent=function(){e.ngModel="",o(),r.onChange({value:e.ngModel})},e.submitText=function(){var t=r.param||{};n.isFunction(t.submit)&&t.submit(e.ngModel)},e.scanText=function(){var n=r.param.scan,t=n.beforeScan&&n.beforeScan(e.ngModel);!1!==t&&a.when(t).then(function(e){l()}).catch(function(e){})};var l=function n(){var o=r.param||{},l=o.scan||{};t.post("扫描二维码").then(function(t){e.ngModel=t,r.onChange({value:e.ngModel});var o=l.onText&&l.onText(t);o&&a.when(o).then(function(e){e&&e.reScan&&i(n,e&&e.delay||l.delay||600)})})}}n.module("dj-ui").component("djuiInput",{bindings:{param:"=",placeholder:"@",icon:"@",focus:"@",initValue:"<",onChange:"&"},template:'\n        <div class="flex">\n          <i class="fa fa-{{$ctrl.icon || $ctrl.param.icon}}" ng-if="$ctrl.icon || $ctrl.param.icon"></i>\n          <input class="flex-1"\n            dj-focus="{{djFocus}}"\n            placeholder="{{$ctrl.placeholder}}"\n            ng-model="ngModel"\n            ng-change="onChange(ngModel)"\n          >\n          <i class="fa fa-qrcode" ng-if="$ctrl.param.scan" ng-click="scanText()"></i>\n          <i class="fa fa-check-square-o" ng-if="$ctrl.param.submit" ng-click="submitText()"></i>\n          <i class="fa fa-times-circle" ng-if="$ctrl.param.clear" ng-click="clearContent()"></i>\n        </div>\n        ',controller:["$scope","$http","$timeout","$q",i]})}(window,angular),function(e,n,t){function i(e,n){var t=this;this.$onChanges=function(n){if(n.mode&&(e.mode=n.mode.currentValue||""),n.max){var t=+n.max.currentValue;(!t||t<0)&&(t=5),t>20&&(t=20),e.max=t,e.stars=Array.from({length:t+1},function(e,n){return n})}if(n.initValue){var i=+n.initValue.currentValue||0;e.value=i}},e.valueOver=-1,e.leave=function(){"show"!=e.mode&&(e.valueOver=-1)},e.overstar=function(n){"show"!=e.mode&&(e.valueOver=n)},e.click=function(n){"show"!=e.mode&&(e.value=n,t.onChange({value:n}))}}n.module("dj-ui").component("djuiStar",{bindings:{mode:"@",max:"<",initValue:"<",onChange:"&"},template:'\n        <div class="flex flex-left flex-v-center" ng-mouseleave="leave()">\n          <span class="star flex-cc" nth="{{i}}"\n            ng-repeat="i in stars"\n            ng-mouseover="overstar(i)"\n            ng-mouseup="click(i)"\n          >{{i>0 && ((valueOver<0 && i<=value || i<=valueOver) && \'★\' || \'☆\') || \'\'}}</span>\n        </div>\n        ',controller:["$scope","$element",i]})}(window,angular),function(e,n,t){n.module("dj-ui").component("djuiTags",{bindings:{param:"<",list:"<",initValue:"<",onChange:"&",editable:"@"},template:'\n        <div class="flex flex-left flex-wrap">\n          <div class="tag flex-cc {{selected[item.value||item]&&\'active\'||\'\'}}"\n            ng-repeat="item in list"\n            ng-click="clickItem(item)"\n          >{{item.title||item}}</div>\n        </div>\n        ',controller:["$scope","$element",function(e,t){function i(){e.list&&e.value&&(e.selected={},e.value.map(function(n){e.selected[n]=1}))}var a=this;this.$onChanges=function(t){if(t.list&&(e.list=t.list.currentValue||[],i()),t.initValue){var a=t.initValue.currentValue;n.isArray(a)||(a=[]),e.value=a,i()}t.editable},e.clickItem=function(n){var t=n.value||n;(e.selected[t]=!e.selected[t])?e.value.push(t):e.value=e.value.filter(function(e){return e!=t}),a.onChange({value:e.value})}}]}),n.module("dj-ui").component("djuiTagsShow",{bindings:{list:"<"},template:'\n        <div class="flex flex-left flex-wrap">\n          <div class="tag flex-cc" ng-repeat="item in list">{{item}}</div>\n        </div>\n        ',controller:["$scope","$element",function(e,t){this.$onChanges=function(t){if(t.list){var i=t.list.currentValue;n.isArray(i)||(i=[]),e.list=i}}}]})}(window,angular),function(e,n,t){n.module("dj-ui").factory("DjWaiteReady",["$q",function(e){function n(){this._isReady=!1,this.deferred=e.defer(),this.promise=this.deferred.promise}return n.prototype={get isReady(){return this._isReady},resolve:function(e){this.isReady||(this.deferred.resolve(e),this._isReady=!0),this.promise=e},reject:function(e){this.isReady||this.deferred.reject(e),this._isReady="reject",this.promise=e},ready:function(n){return"reject"==this._isReady?e.reject(this.promise):(n&&e.when(this.promise).then(n),e.when(this.promise))}},n}])}(window,angular),function(e,n,t){function i(e,t,i){return e&&e.list?n.isString(e.list)?t.post("获取下拉列表",e.list).then(function(e){return i.when(e.list||e.datas.list)}).catch(function(e){return i.reject([])}):n.isFunction(e.list)?i.when(e.list()):i.when(e.list):i.when([])}function a(e){if(g[e])return a(g[e]);var n=v.find(function(n){return n.name==e});return n||(n=v.find(function(e){return"input"==e.name})),n}function o(e){return a(e).name}function r(e){var n=a(e);return n.editTemplate?p[n.editTemplate]:p[e]?p[e]:p.input}function l(e){var n=a(e);return n.showTemplate?p[n.showTemplate]:p[e+"-show"]?p[e+"-show"]:p["initValue-format-show"]}function c(e){var n=a(e);return n.editController?f[n.editController]:f[e]?f[e]:f.input}function s(e){var n=a(e);return n.showController?f[n.showController]:f[e+"-show"]?f[e+"-show"]:f.empty}function u(e){return e.replace(/[:\-_]+(.)/g,function(e,n,t){return t?n.toUpperCase():n})}var d={pre:"dj-form-default-item-"},m=n.module("dj-form"),f={empty:["$scope",function(e){}],input:["$scope",function(e){var n=this;this.$onChanges=function(n){n.initValue&&(e.value=n.initValue.currentValue)},e.change=function(e){n.onChange({value:e})}}],"input-show":["$scope",function(e){this.$onChanges=function(n){n.initValue&&(e.value=n.initValue.currentValue)}}],dropdown:["$scope","$timeout","$http","$q","DjWaiteReady",function(e,n,t,a,o){var r=this,l=new o;e.value="",e.selected="",e.onToggle=function(t){e.focusInput=!1,t&&n(function(){e.focusInput=!0},50)},e.click=function(n){e.selected=n,r.onChange({value:n.value||n})},e.filter=function(n){if(n){var t=new RegExp(n.split("").join("s*"),"i");e.list=e.list_full.filter(function(e){return t.test(e.value?e.value+"-"+e.title:e)})}else e.list=e.list_full},this.$onChanges=function(n){if(n.configs){var o=n.configs.currentValue;if(!o||!o.param)return;e.searchMode=o.param.searchMode,i(o.param,t,a).then(function(n){e.list=e.list_full=n,c(),l.resolve(o)}).catch(function(n){e.list=e.list_full=[]})}n.initValue&&(e.value=n.initValue.currentValue,l.ready(function(n){i(n.param,t,a).then(function(n){e.list=e.list_full=n,c()})}))};var c=function(){e.list&&(e.selected=e.list.find(function(n){return(n.value||n)==e.value}))}}],"dropdown-show":["$scope","$timeout","$http","$q","DjWaiteReady",function(e,n,t,a,o){function r(n,o){e.text="",n&&o&&i(n.param,t,a).then(function(n){var t=n.find(function(e){return e.value==o||e==o});t&&(e.text=t.title||t)})}this.$onChanges=function(n){n.configs&&(e.configs=n.configs.currentValue),n.initValue&&(e.value=n.initValue.currentValue),r(e.configs,e.value)}}],combobox:["$scope","$http","$q",function(e,n,t){this.$onChanges=function(o){if(o.configs){var r=o.configs.currentValue;if(!r||!r.param)return;i(r.param,n,t).then(function(n){e.list=n,a()}).catch(function(n){e.list=[]})}o.initValue&&(e.value=o.initValue.currentValue,a())};var a=function(){e.list&&(e.selected=e.list.find(function(n){return(n.value||n)==e.value}))}}],tags:["$scope","$http","$q",function(e,n,t){this.$onChanges=function(a){if(a.configs){var o=a.configs.currentValue;if(!o||!o.param)return;i(o.param,n,t).then(function(n){e.list=n}).catch(function(n){e.list=[]})}a.initValue&&(e.value=a.initValue.currentValue)}}],"tags-show":["$scope","$http","$q","DjWaiteReady",function(e,n,t,a){function o(a,o){e.text="",a&&o&&i(a.param,n,t).then(function(n){e.value=o.map(function(e){var t=n.find(function(n){return n.value==e||n==e});return t&&t.value||t||e})})}e.value=[],this.$onChanges=function(n){n.configs&&(e.configs=n.configs.currentValue),n.initValue&&(e.value=n.initValue.currentValue),o(e.configs,e.value)}}],radio:["$scope",function(e){}],"check-box":["$scope",function(e){}],"imgs-uploader":["$scope",function(e){var t=this;e.initValue=[],this.$onChanges=function(t){if(t.initValue){var i=t.initValue.currentValue||[];n.isArray(i)||(i=[]),e.initValue=i}},e.onChange=function(e){t.onChange({value:e})}}]},p={"initValue-show":'\n      <div flex-row="5em" class="{{$ctrl.configs.css.hostBodyShow}}">\n        <span class="a">{{$ctrl.configs.title}}</span>\n        <span class="b">{{$ctrl.initValue}}</span>\n      </div>',"text-show":'\n      <div flex-row="5em" class="{{$ctrl.configs.css.hostBodyShow}}">\n        <span class="a">{{$ctrl.configs.title}}</span>\n        <span class="b">{{text}}</span>\n      </div>',"textarea-show":'\n      <div flex-row="5em" class="{{$ctrl.configs.css.hostBodyShow}}">\n        <span class="a">{{$ctrl.configs.title}}</span>\n        <span class="b" br-text="{{$ctrl.initValue}}"></span>\n      </div>',"initValue-format-show":'\n      <div flex-row="5em" class="{{$ctrl.configs.css.hostBodyShow}}">\n        <span class="a">{{$ctrl.configs.title}}</span>\n        <span class="b">{{$ctrl.initValue|formFormat:($ctrl.configs.show.format)}}</span>\n      </div>',"text-format-show":'\n      <div flex-row="5em" class="{{$ctrl.configs.css.hostBodyShow}}">\n        <span class="a">{{$ctrl.configs.title}}</span>\n        <span class="b">{{text|formFormat:($ctrl.configs.show.format)}}</span>\n      </div>',input:'\n      <div class="a flex prompt-top" dj-form-default-tip></div>\n      <djui-input class="b flex"\n        param="$ctrl.configs.param"\n        placeholder="{{$ctrl.configs.param.placeholder}}"\n        init-value="$ctrl.initValue"\n        on-change="$ctrl.onChange({value: value})"\n      ></djui-input>',date:'\n      <div class="a flex prompt-top" dj-form-default-tip></div>\n      <djui-date class="b flex"\n        param="$ctrl.configs.param"\n        placeholder="{{$ctrl.configs.param.placeholder}}"\n        init-value="$ctrl.initValue"\n        on-change="$ctrl.onChange({value: value})"\n      ></djui-date>',textarea:'\n      <div class="a flex prompt-top" dj-form-default-tip></div>\n      <textarea class="b"\n        ng-model="value"\n        ng-change="change(value)"\n        placeholder="{{$ctrl.configs.param.placeholder}}"\n      ></textarea>',dropdown:'\n      <div class="a flex prompt-top" dj-form-default-tip></div>\n      <div class="b inputs flex flex-v-center">\n        <div class="placeholder">{{$ctrl.configs.param.placeholder||\'\'}}</div>\n        <select class="b item-body {{!value&&\'empty\'}}" ng-model="value" ng-change="$ctrl.onChange({value:value})">\n          <option value=""></option>\n          <option ng-repeat="item in list track by $index" value="{{item.value||item}}">{{item.title||item}}</option>\n        </select>\n      </div>\n      ',combobox:'\n      <div class="a flex prompt-top" dj-form-default-tip></div>\n      <div class="b inputs">\n        <select class="item-body" ng-model="value" ng-change="$ctrl.onChange({value:value})">\n          <option value=""></option>\n          <option ng-repeat="item in list track by $index" value="{{item.value||item}}">{{item.title||item}}</option>\n        </select>\n        <div class="caret-down flex flex-v-center"><div></div></div>\n        <djui-input class="flex"\n          param="$ctrl.configs.param"\n          placeholder="{{$ctrl.configs.param.placeholder}}"\n          init-value="$ctrl.initValue"\n          on-change="$ctrl.onChange({value: value})"\n        ></djui-input>\n      </div>\n      ',tags:'\n      <div class="a flex prompt-top" dj-form-default-tip></div>\n      <djui-tags class="item-body"\n        list="list"\n        init-value="value"\n        on-change="$ctrl.onChange({value: value})"\n      ></djui-tags>\n      ',"tags-show":'\n      <div flex-row="5em" class="{{$ctrl.configs.css.hostBodyShow}}">\n        <span class="a">{{$ctrl.configs.title}}</span>\n        <djui-tags-show class="b item-body" list="value"></djui-tags-show>\n      </div>\n      ',radio:'\n      <div class="flex prompt-top" dj-form-default-tip></div>\n    ',"check-box":'\n      <div class="flex prompt-top" dj-form-default-tip></div>\n    ',star:'\n      <div class="a flex prompt-top" dj-form-default-tip></div>\n      <djui-star class=""\n        init-value="$ctrl.initValue"\n        on-change="$ctrl.onChange({value: value})"\n      ></djui-star>\n    ',"star-show":'\n      <div flex-row="5em" class="{{$ctrl.configs.css.hostBodyShow}}">\n        <span class="a">{{$ctrl.configs.title}}</span>\n        <djui-star class="b"\n          init-value="$ctrl.initValue"\n          on-change="$ctrl.onChange({value: value})"\n          mode="show"\n        ></djui-star>\n      </div>\n    ',"imgs-uploader":'\n      <div class="flex prompt-top" dj-form-default-tip></div>\n      <imgs-uploader class="padding-v-1"\n        imgs="initValue"\n        update-img="onChange(imgs)"\n      ></imgs-uploader>',"imgs-uploader-show":'\n      <div class="flex">\n        <imgs-uploader class="ab padding-v-1 {{$ctrl.configs.css.hostBodyShow}}"\n          imgs="$ctrl.initValue"\n          mode="show"\n        ></imgs-uploader>\n      </div>\n    '},v=[{name:"input",showTemplate:"initValue-format-show"},{name:"date",controller:"input"},{name:"textarea",showTemplate:"textarea-show",controller:"input"},{name:"dropdown",showTemplate:"text-format-show",showController:"dropdown-show"},{name:"combobox",showTemplate:"initValue-format-show",showController:"dropdown-show"},{name:"tags"},{name:"radio"},{name:"star",controller:"input"},{name:"check-box"},{name:"imgs-uploader"}],g={select:"dropdown",combo:"combobox"};m.value("DjFormDefaultTemplate",p),m.value("DjFormDefaultDefine",{getSafeType:o,getTemplateEdit:r,getTemplateShow:l}),v.map(function(e){m.component(u(""+d.pre+e.name),{bindings:{configs:"<",theValid:"<",djRequire:"<",initValue:"<",onChange:"&"},template:"",controller:c(e.name)}),m.component(u(""+d.pre+e.name+"-show"),{bindings:{configs:"<",initValue:"<"},template:"",controller:s(e.name)})}),m.directive(u("dj-form-default-tip"),function(){return{restrict:"A",template:"\n          <div class=\"flex title\" dj-form-default-tip-mini></div>\n          <div class=\"prompt error\">{{$ctrl.theValid.valid && ' ' || $ctrl.theValid.tip || 'incorrect'}}</div>\n          "}}).directive(u("dj-form-default-tip-mini"),function(){return{restrict:"A",template:"\n          <div class=\"require\">{{$ctrl.theValid.require && '*' || ''}}</div>\n          <div class=\"prompt-text\">{{$ctrl.configs.title}}</div>\n        "}})}(window,angular),function(e,n,t){n.module("dj-pop").component("djCommentFeedbackShow",{bindings:{item:"<",user:"<",clickItem:"&"},template:'\n      <div class="feedback-top" ng-if="item.praise.length || item.feedback.length">\n      </div>\n      <div class="praise-list" ng-if="item.praise.length">\n        <span>&hearts;</span>\n        <span class="" ng-repeat="uid in item.praise track by $index">{{user[uid].nickname}}</span>\n      </div>\n      <div class="feedback-list" ng-if="item.feedback.length">\n        <div class="feedback-item" ng-mousedown="clickItem(item, feed.uid)" ng-repeat="feed in item.feedback track by $index">\n          <span class="username">{{user[feed.uid].nickname}}</span>\n          <span ng-if="feed.attr.fuid && feed.attr.fuid!=\'0\'"> 回复 <span class="username">{{user[feed.attr.fuid].nickname}}</span></span>\n          <span class="feedback-content">: {{feed.attr.content}}</span>\n        </div>\n      </div>\n    ',controller:["$scope","$http","$q","$animateCss",function(e,n,t,i){var a=this;this.$onChanges=function(n){n.item&&(e.item=n.item.currentValue),n.user&&(e.user=n.user.currentValue)},e.clickItem=function(e,n){a.clickItem({item:e,fuid:n})}}]})}(window,angular),function(e,n,t){n.module("dj-pop").component("djCommentFeedback",{bindings:{param:"<"},template:'\n      <div class="dj-comment-box dj-comment-feedback-box  flex-v flex-stretch flex-between">\n        <div class="list flex-1" ng-click="closeFeedback()">\n          <div class="item flex flex-top" ng-repeat="item in [param.item]" >\n            <div class="left flex-1">\n              <img ng-src="{{user[item.uid].headimgurl}}"/>\n            </div>\n            <div class="right flex-6">\n              <div class="flex user-info">\n                <div class="name">{{user[item.uid].nickname}}</div>\n                <div class="level">{{user[item.uid].level}}</div>\n              </div>\n              <div class="content-box">\n                <div class="content {{more_content&&\' \' ||\' more\'}}" ng-click="more_content = !more_content">{{item.attr.content}}</div>\n                <div class="imgs" ng-if="item.attr.imgs.length">\n                  <img ng-src="{{url}}" ng-click="clickImg(item.attr.imgs, $index)" ng-repeate="url in item.comment.imgs track by $index">\n                </div>\n              </div>\n              <dj-comment-feedback-show item="item" user="user"></dj-comment-feedback-show>\n            </div>\n          </div>\n        </div>\n        <div class="feedback-box flex-v">\n          <div class="user" ng-if="param.fuid">回复 <span class="username">{{user[param.fuid].nickname}}</span></div>\n          <div class="flex input-box">\n            <input class="flex-1" ng-model="feedbackText">\n            <button class="btn btn-default shrink0" ng-click="sendFeedback(feedbackText)">回复</button>\n          </div>\n        </div>\n      </div>\n    ',controller:["$scope","$http","$q","$animateCss",function(e,t,i,a){(function(){e.active=0,e.pageCount=1,e.pop="",this.$onChanges=function(n){if(n.param){if(!n.param.currentValue)return;var t=e.param=n.param.currentValue;e.user=t.user,e.post=t.post}}}).call(this),e.closeFeedback=function(){e.$emit("dj-pop-box-close",{})},e.sendFeedback=function(t){var i=e.param,a=i.fuid,o=i.item,r=i.me;i.post("comment","feedback",{cid:o.id,fuid:a,content:t}).then(function(i){n.isArray(o.feedback)||(o.feedback=[]),o.feedback.push({uid:r.uid,attr:{fuid:a,content:t}}),e.closeFeedback()}).catch(function(e){})}}]})}(window,angular),function(e,n,t){var i=n.module("dj-pop");i.directive("djCommentInput",function(){return{template:'\n      <div class="flex flex-top dj-comment-form-item input prompt-top">\n        <div class="flex flex-left shrink0 title" dj-form-default-tip-mini></div>\n        <input class="flex-1" ng-model="value" ng-change="change(value)" placeholder="{{$ctrl.configs.param.placeholder}}">\n      </div>\n      '}}),i.directive("djCommentTextarea",function(){return{
template:'\n      <div class="flex flex-top dj-comment-form-item input prompt-top">\n        <div class="flex flex-left shrink0 title" dj-form-default-tip-mini></div>\n        <textarea class="flex-1" ng-model="value" ng-change="change(value)" placeholder="{{$ctrl.configs.param.placeholder}}">\n        </textarea>\n      </div>\n      '}}),i.directive("djCommentDropdown",function(){return{template:'\n      <div class="flex flex-top dj-comment-form-item dropdown prompt-top">\n        <div class="flex flex-left shrink0 title" dj-form-default-tip-mini></div>\n        <select class="item-body" ng-model="value" ng-change="$ctrl.onChange({value:value})">\n          <option value="">{{$ctrl.configs.param.placeholder}}</option>\n          <option ng-repeat="item in list track by $index" value="{{$index}}">{{item.title||item}}</option>\n        </select>\n      </div>\n      '}}),i.directive("djCommentImgsUploader",function(){return{template:'\n      <div class="flex dj-comment-form-item imgs-uploader prompt-top">\n        <div class="flex flex-left shrink0 title" dj-form-default-tip-mini></div>\n        <imgs-uploader class="padding-v-1 flex-1"\n          imgs="initValue"\n          update-img="onChange(imgs)"\n        ></imgs-uploader>\n      </div>\n      '}})}(window,angular),function(e,n,t){n.module("dj-pop").component("djCommentPublish",{bindings:{param:"<"},template:'\n      <div class="dj-comment-box publish flex-v flex-stretch">\n        <div class="title flex flex-v-center flex-stretch">\n          <div class="flex-cc btn" ng-click="cancel()">取消</div>\n          <div class="flex-cc btn {{!valid&&\'disabled\'}}" ng-click="publish()">发表</div>\n        </div>\n        <div class="body flex-1 flex-v">\n          <dj-form\n            configs="param.form"\n            init-values="formValue"\n            on-form-values="formValueChange(value, item, valid, dirty)"\n            on-form-status="formStatusChange(item, valid, dirty)"\n          ></dj-form>\n        </div>\n      </div>\n    ',controller:["$scope","$http","$q","$animateCss",function(e,n,t,i){(function(){this.$onChanges=function(n){if(n.param){if(!n.param.currentValue)return;var t=e.param=n.param.currentValue;e.me=t.em}}}).call(this),e.cancel=function(){e.$emit("dj-pop-box-close",{})},e.publish=function(){e.valid&&e.$emit("dj-pop-box-close",{ac:"submit",value:e.value})},function(){e.valid=!1,e.value={},e.formValueChange=function(n,t,i,a){e.value=n,e.formStatusChange(t,i,a)},e.formStatusChange=function(n,t,i){e.valid=t}}.call(this)}]})}(window,angular),function(e,n,t){var i=n.module("dj-pop"),a={form_css:{host:"flex publish",host2:"",hostEdit:"box flex flex-top",hostShow:"flex-1",hostBodyShow:"flex-1 flex-top"},form:{items:[{name:"content",title:"评论",type:"textarea",param:{valid:{require:!0},placeholder:"在此发表评论"}},{name:"pics",title:"图片",type:"imgs-uploader"}],templates___:{input:"<dj-comment-input></dj-comment-input>",textarea:"<dj-comment-textarea></dj-comment-textarea>",dropdown:"<dj-comment-dropdown></dj-comment-dropdown>","imgs-uploader":"<dj-comment-imgs-uploader></dj-comment-imgs-uploader>"}},api:{comment:{root:"comment/",li:"li",remove:"remove",add:"add",praise:"praise",unpraise:"unpraise",feedback:"feedback",removeFeedback:"removeFeedback"},user:{root:"./app/",getWxInfo:"getWxInfo",me:"me"}}};i.component("djCommentList",{bindings:{param:"<"},transclude:!0,transclude_mark:{header:"?djCommentHeader",content:"?djCommentContent",footer:"?djCommentFooter"},template:'\n      <div class="dj-comment-box flex-v flex-stretch">\n        <div class="header transclude-header"></div>\n        <div class="list">\n          <div class="item flex flex-top" ng-repeat="item in items track by $index" >\n            <div class="left flex-1">\n              <img ng-src="{{user[item.uid].headimgurl}}"/>\n            </div>\n            <div class="right flex-6">\n              <div class="main">\n                <dj-comment-item form="form" user="user" item="item" contentbody="contentbody"></dj-comment-item>\n                \n    <div class="flex info">\n      <div class="flex info">\n        <div class="eb-time" am-time-ago="1000*item.t_update"></div>\n        <span class="eb-action"\n          ng-if="item.uid==me.uid"\n          ng-click="deleteComment(item)"\n        >删除</span>\n      </div>\n      <div class="back">\n        <div class="btn-feedback" ng-click="showFeedbackMenu($event, item)"></div>\n        <div class="btn-feedback-menu">\n          <div class="flex">\n            <div ac="praise" ng-if="!item.i_praised"><i class="fa fa-heart-o"> </i> 赞</div>\n            <div ac="unpraise" ng-if="item.i_praised"><i class="fa fa-heart-o"> </i> 取消</div>\n            <div ac="feedback"><i class="fa fa-commenting-o"> </i> 评论</div>\n          </div>\n        </div>\n      </div>\n    </div>\n              </div>\n              <dj-comment-feedback-show item="item" user="user" click-item="openFeedback($event, item, fuid)"></dj-comment-feedback-show>\n            </div>\n          </div>\n        </div>\n        <div class="btns transclude-footer">\n          <div class="djui-btn block primary" ng-click="openPublist()">\n            发贴\n          </div>\n        </div>\n      </div>\n    ',controller:["$scope","$http","$q","$animateCss","$transclude","$element","DjPop",function(e,t,i,o,r,l,c){r(function(n){var t=[].filter.call(n,function(e){return"dj-comment-content"==(e.tagName||"").toLowerCase()});t.length>0&&(e.contentbody=t[0].outerText)});var s=function i(a,o,r){return"comment"==a&&(r=n.extend({module:e.param.module,mid:e.param.mid},r)),a=i.api[a],t.post(a.root+(a[o]||o),r)};(function(){e.active=0,e.pageCount=1;var i={};this.$onChanges=function(t){if(t.param){if(!t.param.currentValue)return;var o=n.merge({},t.param.currentValue);o.api=s.api=n.merge({},a.api,o.api),n.equals(i,o)||(i=n.merge({},o),u.loadData(e.param=o))}},e.clickImg=function(e,n){t.post("翻译资源",{urls:e}).then(function(e){var t=e.datas.urls;c.gallery({param:{imgs:t,active:n}})})}}).call(this),e.user={};var u=e.theData={activeItem:!1,loadData:function(n){e.form=n.form||a.form,e.form.css||(e.form.css=a.form_css);var t=s("user","me",{}).then(function(n){e.me=n.datas;var t=n.datas.uid;e.user=e.user||{},e.user[t]=e.user[t]||{},e.user[t].headimgurl=n.datas.wx.headimgurl,e.user[t].nickname=n.datas.wx.nickname}).catch(function(e){});s("comment","li",{count:10}).then(function(n){var a=n.datas.list||[],o=e.items=a.filter(function(e){return"publish"==e.type&&e.attr&&(e.attr.content||e.attr.pics)});o.map(function(e){e.praise=a.filter(function(n){return"praise"==n.type&&n.cid==e.id}).map(function(e){return e.uid}),e.feedback=a.filter(function(n){return"feedback"==n.type&&n.cid==e.id&&n.attr&&(n.attr.content||n.attr.pics)})}),i.when(t).then(function(){o.map(function(n){n.i_praised=!!n.praise.find(function(n){return n==e.me.uid})})});var r=[];a.map(function(e){r.indexOf(e.uid)<0&&r.push(e.uid)}),s("user","getWxInfo",{uids:r}).then(function(n){e.user=e.user||{},n.datas.list.map(function(n){e.user[n.uid]=n})}).catch(function(e){})}).catch(function(n){e.items=[]})}};(function(){function t(a){if(a){var o=n.element(a.target);o.attr("ac")||(o=o.parent()),o.attr("ac")||(o=o.parent()),"praise"==o.attr("ac")&&e.praise(a,s),"unpraise"==o.attr("ac")&&e.unpraise(a,s),"feedback"==o.attr("ac")&&e.openFeedback(a,s)}r.closing?i.when(r.closing).then(t):setTimeout(function(){r(c)})}function a(e,a){i.when(a).then(function(){document.addEventListener("mousedown",t),document.addEventListener("touchstart",t)}),o(n.element(e),{from:{width:"0"},to:{width:"11em"},easing:"ease",duration:.3}).start().then(function(){c=e,l=!1}),l=e}function r(e){if(document.removeEventListener("mousedown",t),document.removeEventListener("touchstart",t),!e)return i.when(1);var a=o(n.element(e),{from:{width:"11em"},to:{width:"0"},easing:"ease",duration:.3}),l=i.defer();r.closing=l.promise,a.start().then(function(e){c=!1,r.closing&&(l.resolve("1"),r.closing=!1)}),setTimeout(function(){c=!1,r.closing&&(l.resolve("1"),r.closing=!1)},320)}var l=!1,c=!1,s=!1;e.showFeedbackMenu=function(e,t,o){s=t;var l;r.closing?l=i.when(r.closing).then(function(){r(c)}):r(c);var u=n.element(e.target).parent()[0].querySelector(".btn-feedback-menu");u!==c&&a(u,l)}}).call(this),function(){e.openFeedback=function(n,t,i){function a(){document.removeEventListener("mouseup",a),document.removeEventListener("touchend",a),setTimeout(function(){c.show("dj-comment-feedback",{param:{param:{me:e.me,user:e.user,item:t,fuid:i,post:s}}})})}document.addEventListener("mouseup",a),document.addEventListener("touchend",a)}}.call(this),function(){function n(n,t){s("comment",n,{cid:t.id}).then(function(i){t.praise=t.praise.filter(function(n){return n!=e.me.uid}),t.i_praised="praise"==n,"praise"==n&&(t.praise.push(e.me.uid),t.i_praised=!0)}).catch(function(e){})}e.praise=function(e,t){n("praise",t)},e.unpraise=function(e,t){n("unpraise",t)}}.call(this),function(){e.deleteComment=function(n){t.post("显示对话框/confirm",{body:"删除后，本贴及其回帖和点赞均不可恢复。确认？",title:"删除前，请确认："}).then(function(t){s("comment","remove",{id:n.id}).then(function(t){e.items=e.items.filter(function(e){return e.id!=n.id})})})},e.openPublist=function(){c.show("dj-comment-publish",{param:{param:{me:e.me,user:e.user,form:e.form,post:s}}}).then(function(n){"submit"==n.ac&&s("comment","add",{data:n.value}).then(function(t){e.items.push({id:t.datas.id,uid:e.me.uid,t_update:t.datas.t_update||.001*new Date,type:"publish",praise:[],feedback:[],attr:n.value})}).catch(function(e){})})}}.call(this)}]}),i.component("djCommentItem",{bindings:{form:"<",user:"<",item:"<",contentbody:"<"},template:'\n    <div class="flex user-info">\n      <div class="name">{{$ctrl.user[$ctrl.item.uid].nickname}}</div>\n      <div class="level">{{$ctrl.user[$ctrl.item.uid].level}}</div>\n    </div>\n    <div class="content-box transclude-content"></div>\n    ',controller:["$scope","$element","$compile","$timeout",function(e,t,i,a){function o(o){a(function(){var a=o||r,l=n.element(t[0].querySelector(".transclude-content"));l.html(a),i(l.contents())(e)})}this.$onChanges=function(n){n.item&&(e.item=n.item.currentValue),n.user&&(e.user=n.user.currentValue),n.contentbody&&o(n.contentbody.currentValue)};var r='\n      <div class="content {{more_content&&\' \' ||\' more\'}}" ng-click="more_content = 1">{{$ctrl.item.attr.content}}</div>\n      <div class="imgs flex flex-left flex-wrap" ng-if="$ctrl.item.attr.pics.length">\n        <img ng-src="{{url|assert:90}}" ng-click="clickImg($ctrl.item.attr.pics, $index)" ng-repeat="url in $ctrl.item.attr.pics track by $index">\n      </div>\n      ',r='\n      <dj-form\n        mode="\'show\'"\n        configs="$ctrl.form"\n        init-values="item.attr"\n      ></dj-form-show>\n      '}]})}(window,angular),function(e,n,t){n.module("dj-pop").component("djToast",{bindings:{text:"@",delay:"@"},transclude:!0,template:"<span>{{$ctrl.text}}</span>",controller:["$scope","$element","$q","$animateCss",function(e,t,i,a){function o(e){setTimeout(function(){r().then(function(){u(e)})})}function r(){if(o.done)return i.when(o.done);var e=a(t,{from:{opacity:0},to:{opacity:1},easing:"ease",duration:.5});return o.done=e.start().then(function(){t.css("opacity",1),o.done=1}).catch(function(e){})}function l(){a(t,{from:{opacity:1},to:{opacity:0},easing:"ease",duration:.6}).start().then(function(n){e.$emit("dj-pop-box-close",{})})}var c=this;this.$onChanges=function(e){if(e.delay){var t=+e.delay.currentValue||0;n.isNumber(t)||(t=2e3),t>15e3&&(t=15e3),o(t)}e.text&&o(c.delay)};var s,u=function(e){clearTimeout(s),s=setTimeout(function(){l()},e)}}]})}(window,angular),function(e,n,t){var i=1;n.module("dj-ui").directive("djCollapse",["$rootScope","$parse","$timeout",function(e,n,t){return{restrict:"A",link:function(a,o,r){function l(n){n=n||"0",n=a.$eval(n),o[0].style.height=o[0].scrollHeight+"px",t(function(){o[0].style.overflow="hidden",o[0].style.height=o[0].scrollHeight+"px",o[0].style.height=n?o[0].scrollHeight+"px":"0",n&&e.$broadcast("dj-collapse-open-broadcast",{element:o})})}function c(e){parseInt(o[0].style.height)>0&&(o[0].style.height="auto",o[0].style.overflow="visible")}function s(e){o.djCollapseGroup=e}function u(e,t){if(o!=t.element&&(!o.djCollapseGroup||o.djCollapseGroup===t.element.djCollapseGroup)){var i=n(r.djCollapseGroup);a.$apply(function(){i(a,{element:o})})}}o.djCollapseId=i++,r.$observe("djCollapse",l),r.$observe("group",s),a.$on("dj-collapse-open-broadcast",u),o[0].addEventListener("webkitTransitionEnd",c)}}}])}(window,angular),function(e,n,t){function i(e,n,i,o){var r=this;this.$onChanges=function(n){if(n.initValue){var t=n.initValue.currentValue||"";e.ngModel=new Date(Date.parse(t.replace(/-/g,"/")))}},e.onChange=function(e){var n=r.format||r.param&&r.param.format||"yyyy-MM-dd";e!==t&&r.onChange({value:a(e,n)})}}function a(e,n){if(!(e instanceof Date))return"";var t={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours()%12==0?12:e.getHours()%12,"H+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()},i={0:"/u65e5",1:"/u4e00",2:"/u4e8c",3:"/u4e09",4:"/u56db",5:"/u4e94",6:"/u516d"};/(y+)/.test(n)&&(n=n.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),/(E+)/.test(n)&&(n=n.replace(RegExp.$1,(RegExp.$1.length>1?RegExp.$1.length>2?"/u661f/u671f":"/u5468":"")+i[e.getDay()+""]));for(var a in t)new RegExp("("+a+")").test(n)&&(n=n.replace(RegExp.$1,1==RegExp.$1.length?t[a]:("00"+t[a]).substr((""+t[a]).length)));return n}n.module("dj-ui").component("djuiDate",{bindings:{initValue:"<",onChange:"&",format:"<",param:"<",placeholder:"@"},template:'\n        <div class="flex djui-input-box">\n          <input class="flex-1" type="date"\n            placeholder="{{$ctrl.placeholder}}"\n            ng-model="ngModel"\n            ng-change="onChange(ngModel)"\n          >\n        </div>\n        ',controller:["$scope","$http","$timeout","$q",i]}),n.module("dj-ui").filter("timespan",function(){return function(e,n){var t=new Date;return t.setTime(1e3*e),a(t,n||"yyyy-MM-dd")}})}(window,angular),function(e,n,t){n.module("dj-ui").component("djuiDialog",{bindings:{param:"<"},scope_______:{dialogShow:"=",backClose:"@",dlgBody:"@",dlgTitle:"@",hideCancel:"@",hideOk:"@",onClose:"&",onClickBack:"&"},transclude:{title:"?djuiDialogTitle",body:"?djuiDialogBody",footer:"?djuiDialogFooter"},template:'\n      <div class="djui-dialog flex-cc">\n        <div class="back" ng-click="clickBack()"></div>\n        <div class="box">\n          <div class="title" ng-transclude="title">\n            <div class="text">\n              {{param.title}}\n            </div>\n          </div>\n          <div class="body" ng-transclude="body">\n            <div class="content">{{param.body}}</div>\n          </div>\n          <div class="footer" ng-transclude="footer">\n            <div class="thin-btns flex flex-arround">\n              <div class="thin-btn {{param.cancel.css||\'default\'}}" ng-if="!param.cancel.hide" ng-click="cancel()">{{param.cancel.text||\'取消\'}}</div>\n              <div class="thin-btn {{param.OK.css||\'primary\'}}" ng-if="!param.OK.hide" ng-click="OK()">{{param.OK.text||\'确定\'}}</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    ',controller:["$scope","$element","$q","$animateCss",function(e,n,t,i){function a(e){if(e=e&&1||0,a.running)return t.when(a.running);var o=i(n,{from:{opacity:e-1},to:{opacity:e},easing:"ease",duration:.5});return a.running=o.start().then(function(){n.css("opacity",e),a.running=1}).catch(function(e){})}e.param={},this.$onChanges=function(n){n.param&&(e.param=n.param.currentValue||{}),a(1)};var o=function(n){if(e.param.beforeClose){var i=e.param.beforeClose(n);if(!1===i)return;t.when(i).then(function(t){a(0),e.$emit("dj-pop-box-close",n)}).catch(function(e){})}else a(0),e.$emit("dj-pop-box-close",n)};e.clickBack=function(){e.param.backClose&&o("cancel")},e.OK=function(){o("OK")},e.cancel=function(){o("cancel")}}]})}(window,angular),function(e,n,t){n.module("dj-ui").component("djuiGallery",{bindings:{imgs:"<",active:"<",nav:"@",pageCount:"@",onPage:"&",btns:"<"},transclude:!0,replace:!0,template:'\n      <div class="djui-gallery-box">\n        <div class="djui-gallery-list" ng-transclude>\n          <div class="djui-gallery-item item-{{$index+1-active}}" ng-repeat="img in imgs track by $index" >\n            <img class="" ng-src="{{img}}"/>\n          </div>\n        </div>\n        <div class="djui-gallery-debug" ng-if="debug">\n          {{debug}}\n        </div>\n        <div class="djui-gallery-top" ng-if="isMoving">\n        </div>\n      </div>\n      <div class="djui-gallery-nav flex flex-between">\n        <div class="dots flex flex-1 flex-center" ng-if="1">\n          <div ng-click="scrollTo($index)" ng-repeat="img in imgs track by $index">{{$index==active&&\'●\'||\'○\'}}</div>\n        </div>\n        <div class="btns flex flex-center" ng-if="$ctrl.btns.length">\n          <div ng-click="clickButton(btn)" ng-repeat="btn in $ctrl.btns track by $index">\n            <div class="{{btn.css}}">{{btn.text||\'\'}}</div>\n          </div>\n        </div>\n      </div>\n    ',controller:["$scope","$window","$element","$q","$animateCss",function(e,t,i,a,o){function r(n){setTimeout(function(){c.init();var t=i[0];t=i[0].querySelector(n),t.addEventListener("mousedown",c.onTouchstart,!0),t.addEventListener("touchstart",c.onTouchstart,!0),t.addEventListener("mousemove",c.onTouchmove,!0),t.addEventListener("touchmove",c.onTouchmove,!0),t.addEventListener("mouseup",c.onTouchend,!0),t.addEventListener("touchend",c.onTouchend,!0),s(e.active)})}var l=this;e.active=0,e.pageCount=1,e.imgs=[],this.$onChanges=function(n){n.imgs&&(e.imgs=n.imgs.currentValue||[],e.pageCount=e.imgs.length),n.pageCount&&n.pageCount.currentValue&&(e.pageCount=n.pageCount.currentValue||1,setTimeout(c.init)),n.active&&(e.active=n.active.currentValue||0)},this.$onInit=function(){r(".djui-gallery-box")};var c={min:10,fastPx:5,slowTurn:.3,init:function(){c.box=i[0].querySelector(".djui-gallery-box"),n.element(c.box).css("width",i[0].clientWidth);var t=c.box.clientWidth;c.list=i[0].querySelector(".djui-gallery-list"),n.element(c.list).css("width",t*e.pageCount+"px"),n.element(c.list).children().css("width",t+"px")},checkFast:function(e){var n=e-c.fast.t;return!(Math.abs(c.x1-c.fast.x)*c.fastPx<n&&(c.fast={x:c.x1,t:e},1))},minMove:function(e){return c.checkFast(e)?c.box.clientWidth*c.slowTurn*.3:c.box.clientWidth*c.slowTurn},setMoving:function(n){e.isMoving=n,e.$apply()},onTouchstart:function(e){c.touchstart=!0,c.begin=!0,c.moved=!1,c.canceled=!1,c.setMoving(!1),c.x0=c.x1=(e.touches&&e.touches[0]||e).clientX,c.y0=c.y1=(e.touches&&e.touches[0]||e).clientY,c.fast={x:c.x1,t:e.timeStamp},c.offsetLeft=parseInt(c.list.style.left)||0},onTouchmove:function(e){if(c.begin&&!c.canceled){c.touchstart=!0,c.x1=(e.touches&&e.touches[0]||e).clientX,c.y1=(e.touches&&e.touches[0]||e).clientY,c.list.style.left=c.offsetLeft+c.x1-c.x0+"px";var n=Math.abs(c.x1-c.x0),t=Math.abs(c.y1-c.y0);if(!c.moved&&t>c.min&&t>n)return void(c.canceled=!0);(Math.abs(c.x1-c.x0)>=c.min||Math.abs(c.y1-c.y0)>=c.min)&&(c.moved=!0),c.checkFast(e.timeStamp),e.preventDefault(),e.stopPropagation(),c.moved&&c.setMoving(!0)}},onTouchend:function(n){c.begin=!1,c.touchstart=!1;var t=parseInt(c.list.style.left),i=c.offsetLeft-t,a=c.minMove(n.timeStamp);if(!c.moved)return e.$emit("dj-pop-box-close",{active:e.active}),void(e.imgs.length&&(n.preventDefault(),n.stopPropagation(),c.setMoving(!1)));s(i>a?e.active+1:i<-a?e.active-1:e.active),c.moved&&(n.preventDefault(),n.stopPropagation()),c.setMoving(!1)}},s=e.scrollTo=function(t){c.init(),t<0&&(t=0),t>=e.pageCount&&(t=e.pageCount-1),e.active=t,o(n.element(c.list),{from:{left:c.list.style.left},to:{left:-t*c.box.clientWidth+"px"},easing:"ease",duration:.2}).start().then(function(n){e.active=t,l.onPage({page:t})}).catch(function(e){})};e.clickButton=function(n){var t=n.fn&&n.fn(e.active,e.imgs);t&&a.when(t).then(function(n){e.pageCount=e.imgs.length,e.pageCount<1&&e.$emit("dj-pop-box-close",{active:e.active}),s(e.active)}).catch(function(e){})}}]})}(window,angular),function(e,n,t){n.module("dj-ui").factory("IMG",["$q",function(n){function t(e,t,o,r){var l=u();if(o)for(var c in o)o.hasOwnProperty(c)&&l.append(c,o[c]);return d(t).then(function(n){return a(t,n).then(function(n){return l.append(r||"file",n,t.name),i(e,l)})}).catch(function(e){return n.reject(e)})}function i(t,i){var a=n.defer(),o=new e.XMLHttpRequest;return o.open("post",t),o.onreadystatechange=function(){if(4==o.readyState){var e=o.status;if(e>=200&&e<300){var n=JSON.parse(o.responseText);a.resolve(n)}else a.reject(o)}},o.upload.onprogress=function(e){a.notify(e)},o.send(i),a.promise}function a(e,t){if(!/\/(?:jpeg|png|gif|bmp)/i.test(e.type))return n.reject("不支持的图片格式");var i=n.defer(),a=new FileReader;return a.onload=function(n){function a(){var e=o(l,t),n=c(e);l=null,i.resolve(n)}var r=this.result;if(r.length<=m)return void i.resolve(e);var l=new Image;l.src=r,l.complete?a():l.onload=a},a.readAsDataURL(e),i.promise}function o(e,n){var t=(e.src.length,e.width),i=e.height,a=document.createElement("canvas"),o=a.getContext("2d"),l=t*i/3e6;l>1?(l=Math.sqrt(l),t/=l,i/=l):l=1,a.width=t,a.height=i,o.fillStyle="#fff",o.fillRect(0,0,a.width,a.height);var c=t*i/1e6;if(c>1){c=~~(Math.sqrt(c)+1);var s=~~(t/c),u=~~(i/c),d=document.createElement("canvas"),m=d.getContext("2d");d.width=s,d.height=u;for(var f=0;f<c;f++)for(var p=0;p<c;p++)m.drawImage(e,f*s*l,p*u*l,s*l,u*l,0,0,s,u),o.drawImage(d,f*s,p*u,s,u);d.width=d.height=0}else o.drawImage(e,0,0,t,i);var v=r(n,a,t,i);return a.width=a.height=0,v}function r(e,n,t,i){if(e<1||e>8)return n.toDataURL("image/jpeg",.2);var a=document.createElement("canvas");l(e,a,a.getContext("2d"),n,t,i);var o=a.toDataURL("image/jpeg",.2);return a.width=a.height=0,o}function l(e,n,t,i,a,o){if(!(e<1||e>8)){var r,l,c=e,s=e>4;s&&(c=9-c),c-=1;var u=[1,-1,-1,1][c],d=[1,1,-1,-1][c];r=-a/2,l=-o/2,s?(n.width=o,n.height=a,t.translate(-l,-r),t.rotate(1.5*Math.PI)):(n.width=a,n.height=o,t.translate(-r,-l)),t.scale(u,d),t.drawImage(i,0,0,a,o,r,l,a,o)}}function c(e){var n,t=e.split(",");n=t[0].indexOf("base64")>=0?atob(t[1]):unescape(t[1]);for(var i=t[0].split(":")[1].split(";")[0],a=new Uint8Array(n.length),o=0;o<n.length;o++)a[o]=n.charCodeAt(o);return new s([a],i)}function s(n,t){try{return new Blob(n,{type:t})}catch(a){var i=new(e.BlobBuilder||e.WebKitBlobBuilder||e.MSBlobBuilder);return n.forEach(function(e){i.append(e)}),i.getBlob(t)}}function u(){return~navigator.userAgent.indexOf("Android")&&~navigator.vendor.indexOf("Google")&&!~navigator.userAgent.indexOf("Chrome")&&navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop()<=534?new FormDataShim:new FormData}function d(e){var t=n.defer(),i=new FileReader;return i.onload=function(e){var n=new DataView(this.result);if(65496!=n.getUint16(0,!1))return t.resolve(-2);for(var i=n.byteLength,a=2;a<i;){var o=n.getUint16(a,!1);if(a+=2,65505==o){if(1165519206!=n.getUint32(a+=2,!1))return t.resolve(-1);var r=18761==n.getUint16(a+=6,!1);a+=n.getUint32(a+4,r);var l=n.getUint16(a,r);a+=2;for(var c=0;c<l;c++)if(274==n.getUint16(a+12*c,r))return t.resolve(n.getUint16(a+12*c+8,r))}else{if(65280!=(65280&o))break;a+=n.getUint16(a,!1)}}return t.resolve(-1)},i.readAsArrayBuffer(e),t.promise}var m=2e5;return{upload:t}}])}(window,angular),function(){function e(e,n,t,i){var a=this;this.imgData={uploadings:[]};e.imgList=[],this.countError=0,this.$onInit=function(){},this.$onChanges=function(n){n.imgs&&(e.imgList=angular.merge([],n.imgs.currentValue||[])),n.maxCount&&(e.maxCount=+n.maxCount.currentValue||9),n.mode&&(e.mode=n.mode.currentValue||"")},this.deleteImg=function(n,t){if(!(n<0||n>=e.imgList.length))return i.confirm("您确认要删除当前图片?").then(function(i){t.splice(n,1),e.imgList=angular.merge([],t)}).then(function(){var n=angular.merge([],e.imgList);a.updateImg({imgs:n,value:n}),a.onChange({imgs:n,value:n})})},e.clickImg=function(n){i.gallery({imgs:e.imgList,active:n,btns:"show"==e.mode?[]:[{css:"icon-del",fn:a.deleteImg}]}).then(function(e){}).catch(function(e){})},this.addImg=function(n){if(!(e.imgList.length>=e.maxCount)){e.imgList.push(n);var t=angular.merge([],e.imgList);a.updateImg({imgs:t,value:t}),a.onChange({imgs:t,value:t})}};var o=this,r=e.File={subTreeId:0,uploadingFiles:[],onFile:function(n){if(n){r.uploadingFiles=r.uploadingFiles||[];for(var t=0;t<n.length;t++)r.uploadingFiles.push(n[t]);e.$apply(),this.upload()}},uploadFile:function(n,i,a){t.upload(n,i,a).then(function(e){e.datas&&o.addImg(e.datas.url);var n=r.uploadingFiles.indexOf(i);r.uploadingFiles.splice(n,1)},function(n){i.error=n,setTimeout(function(){var n=r.uploadingFiles.indexOf(i);r.uploadingFiles.splice(n,1),e.$apply()},5e3)},function(e){i.per=(e.loaded/i.size*80).toFixed(2),i.per>100&&(i.per=100)})},upload:function(){return n.post("签名","upload/img").then(function(e){return e.datas}).catch(function(e){return{url:"/api/file/upload/img",data:{}}}).then(function(e){angular.forEach(r.uploadingFiles,function(n){r.uploadFile(e.url,n,e.data)})})}}}angular.module("dj-ui").filter("preview",function(){return function(e,n,t){return e}}).directive("multiFileUpload",function(){return{controller:["$scope","$element",function(e,n){n.bind("change",function(n){e.change&&e.change({$files:n.target.files})})}],scope:{change:"&"}}}).component("imgsUploader",{template:'\n        <div class="box flex flex-left flex-wrap">\n          <div class="img preview" ng-click="clickImg($index)" ng-repeat=\'img in imgList track by $index\'>\n            <img ng-src="{{img|preview}}" />\n          </div>\n          <div class="img uploading" ng-repeat=\'file in File.uploadingFiles track by $index\'>\n            <div class="per">{{file.error||(file.per+\'%\')}}</div>\n          </div>\n          <div class="img add" ng-if="mode!=\'show\' && imgList.length < (maxCount||9)">\n            <input type="file" multiple accept="image/*,video/mp4" multi-file-upload change="File.onFile($files)">\n          </div>\n        </div>\n      ',bindings:{appData:"<",maxCount:"<",imgs:"<",mode:"@",onChange:"&",updateImg:"&"},controller:["$scope","$http","IMG","DjPop",e]})}(),angular.module("ngTouch").directive("leftSwiptDelete",["$parse","$compile","$swipe","$q",function(e,n,t,i){var a=30,o=100;return function(r,l,c){function s(e){if(!p)return!1;var n=Math.abs(e.y-p.y),t=e.x-p.x,i=b?t>a:-t>a;return v&&n<75&&n/Math.abs(t)<.3&&i}function u(e){t.bind(e,{start:function(e,n){p=e,v=!0},move:function(e,n){var t=e.x-p.x-(b?o:0);t>0&&(t=0),y(t)},cancel:function(e){v=!1,y(0)},end:function(e,n){b=s(e)?!b:b,y(b?"show":"hide")}},$),angular.element(e).on("click",function(){y("hide")})}function d(){l.css("position","relative"),g=n('<div class="left-swipe-delete-btn flex-cc">删除</div>')(r),l.append(g),g.bind("click",function(e){var n=x(r,{$event:e});if(!1===n)return void y("hide");i.when(n).then(function(){y(0),b=!1}).catch(function(){y("hide")})})}function m(e,n){return!(!e||!n)&&(e==n[0]||e==n||m(e.parentElement,n))}function f(){var e=function e(n){document.removeEventListener("mousedown",e,!1),document.removeEventListener("touchstart",e,!1);var t=n.target||n.srcElement;m(t,g)||m(t,y.element)||y("hide")};document.addEventListener("mousedown",e,!1),document.addEventListener("touchstart",e,!1)}var p,v,g,h=c.leftSwiptDelete,x=e(h),b=!1,$=["touch"];angular.isDefined(c.ngSwipeDisableMouse)||$.push("mouse");var w;setTimeout(function(){var e=l.children();w=y.element=e.eq(0),w.css({position:"relative","z-index":"2"}),u(w),e.length>=2?(g=e.eq(1),g.addClass("left-swipe-delete-btn")):d()});var y=function e(n){e.element||(e.element=l.children().eq(0),e.element.css("display","block")),"show"==n?(e.element.css("transition-duration","0.3s"),e.element.css("transform","translateX(-"+o+"px)"),f(),b=!0):"hide"==n?(e.element.css("transition-duration","0.3s"),e.element.css("transform","translateX(0)"),b=!1):(e.element.css("transition-duration","0s"),e.element.css("transform","translateX("+n+"px)"))}}}]);